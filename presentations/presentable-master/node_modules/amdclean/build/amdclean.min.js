!function(e,n){"use strict";"function"==typeof define&&define.amd?(n.env="undefined"!=typeof exports?"node":"web",n.amd=!0,define(["esprima","estraverse","escodegen","underscore"],function(e,r,t,i){return n({esprima:e,estraverse:r,escodegen:t,underscore:i})})):"undefined"!=typeof exports?(n.env="node",n()):(n.env="web",e.amdclean=n())}(this,function cleanamd(amdDependencies){var codeEnv=cleanamd.env,esprima=cleanamd.amd?amdDependencies.esprima:"node"===codeEnv?require("esprima"):window.esprima,estraverse=cleanamd.amd?amdDependencies.estraverse:"node"===codeEnv?require("estraverse"):window.estraverse,escodegen=cleanamd.amd?amdDependencies.escodegen.generate?amdDependencies.escodegen:"node"===codeEnv?require("escodegen"):window.escodegen:require("escodegen"),_=cleanamd.amd?amdDependencies.underscore:"node"===codeEnv?require("lodash"):window._,fs="node"===codeEnv?require("fs"):{},publicAPI={VERSION:"0.4.0",defaultOptions:{globalObject:!1,globalObjectName:"amdclean",rememberGlobalObject:!0,removeAllRequires:!1,ignoreModules:[],escodegen:{},esprima:{comment:!0,loc:!0},globalModules:[],commentCleanName:"amdclean"},env:codeEnv,errorMsgs:{emptyCode:"There is no code to generate the AST with",emptyAst:function(e){return"An AST is not being passed to the "+e+"() method"},invalidObject:function(e){return"An object is not being passed as the first parameter to the "+e+"() method"},lodash:"There is not an _.isPlainObject() method.  Make sure you have included lodash (https://github.com/lodash/lodash).",esprima:"There is not an esprima.parse() method.  Make sure you have included esprima (https://github.com/ariya/esprima).",estraverse:"There is not an estraverse.replace() method.  Make sure you have included estraverse (https://github.com/Constellation/estraverse).",escodegen:"There is not an escodegen.generate() method.  Make sure you have included escodegen (https://github.com/Constellation/escodegen)."},dependencyBlacklist:{require:!0,exports:!0,module:!0},readFile:function(e){return"node"!==publicAPI.env?"":fs.readFileSync(e,"utf8")},isDefine:function(e){var n=e.expression||{},r=n.callee;return"ExpressionStatement"===e.type&&!_.isUndefined(n)&&"CallExpression"===n.type&&"Identifier"===r.type&&"define"===r.name},isRequire:function(e){var n=e.expression||{},r=n.callee;return"ExpressionStatement"===e.type&&!_.isUndefined(n)&&"CallExpression"===n.type&&"Identifier"===r.type&&"require"===r.name},isRequireExpression:function(e){return"CallExpression"===e.type&&e.callee&&"require"===e.callee.name},isObjectExpression:function(e){return e&&_.isPlainObject(e)&&"ObjectExpression"===e.type},isFunctionExpression:function(e){return e&&_.isPlainObject(e)&&"FunctionExpression"===e.type},prefixReservedWords:function(name){var reservedWord=!1;try{name.length&&eval("var "+name+" = 1;")}catch(e){reservedWord=!0}return reservedWord===!0?"_"+name:name},normalizeModuleName:function(e){if(e=e||"","{}"===e)return e;var n=e.replace(/\./g,"").replace(/[^A-Za-z0-9_$]/g,"_").replace(/^_+/,"");return publicAPI.prefixReservedWords(n)},returnExpressionIdentifier:function(e){return{type:"ExpressionStatement",expression:{type:"Identifier",name:e}}},convertToObjectDeclaration:function(e){var n=(e.node,e.moduleName),r=e.moduleReturnValue,t=publicAPI.options,i=function(){return t.globalObject===!0&&t.globalObjectName?{type:"ExpressionStatement",expression:{type:"AssignmentExpression",operator:"=",left:{type:"MemberExpression",computed:!0,object:{type:"Identifier",name:t.globalObjectName},property:{type:"Literal",value:n,raw:""+n}},right:r}}:{type:"VariableDeclaration",declarations:[{type:"VariableDeclarator",id:{type:"Identifier",name:n},init:r}],kind:"var"}}();return i},convertToIIFE:function(e){var n=e.callbackFuncParams,r=e.callbackFunc,t=e.dependencyNames;return{type:"ExpressionStatement",expression:{type:"CallExpression",callee:{type:"FunctionExpression",id:null,params:n,defaults:[],body:r.body,rest:r.rest,generator:r.generator,expression:r.expression},arguments:t}}},convertToIIFEDeclaration:function(e){var n=e.moduleName,r=e.callbackFuncParams,t=e.callbackFunc,i=e.dependencyNames,o=publicAPI.options,a={type:"CallExpression",callee:{type:"FunctionExpression",id:{type:"Identifier",name:""},params:r,defaults:[],body:t.body,rest:t.rest,generator:t.generator,expression:t.expression},arguments:i},s=function(){return o.globalObject===!0&&o.globalObjectName?{type:"ExpressionStatement",expression:{type:"AssignmentExpression",operator:"=",left:{type:"MemberExpression",computed:!0,object:{type:"Identifier",name:o.globalObjectName},property:{type:"Literal",value:n,raw:""+n}},right:a}}:{type:"VariableDeclaration",declarations:[{type:"VariableDeclarator",id:{type:"Identifier",name:n},init:a}],kind:"var"}}();return s},convertToFunctionExpression:function(e){var n=e.isDefine,r=e.isRequire,t=(e.node,e.moduleName),i=e.dependencies,o=i.length,a=publicAPI.options,s=function(){for(var e,n=[],r=-1;++r<o;)e=i[r],a.globalObject===!0&&a.globalObjectName&&"{}"!==e?n.push({type:"MemberExpression",computed:!0,object:{type:"Identifier",name:a.globalObjectName},property:{type:"Literal",value:publicAPI.normalizeModuleName(e),raw:""+publicAPI.normalizeModuleName(e)},name:publicAPI.normalizeModuleName(e)}):n.push({type:"Identifier",name:publicAPI.normalizeModuleName(e)});return n}(),c=e.moduleReturnValue,l=function(){var e=[];return c&&c.body&&_.isArray(c.body.body)&&(e=_.where(c.body.body,{type:"ReturnStatement"}),e.length)?!0:!1}(),p=!1,u=function(){for(var e,n,r=[],t=-1,i=c.params||[];++t<o;)e=i[t],n=e?e.name:s[t].name,"exports"===n&&(p=!0),"{}"===n&&(n="module"),r.push({type:"Identifier",name:n});return r}();return!l&&p&&c.body.body.push({type:"ReturnStatement",argument:{type:"Identifier",name:"exports"}}),n?publicAPI.convertToIIFEDeclaration({moduleName:t,dependencyNames:s,callbackFuncParams:u,hasExportsParam:p,callbackFunc:c}):r?publicAPI.convertToIIFE({dependencyNames:s,callbackFuncParams:u,callbackFunc:c}):void 0},convertDefinesAndRequires:function(e){var n,r,t,i,o,a,s,c,l=publicAPI.isDefine(e),p=publicAPI.isRequire(e),u={},d=!1;if("Program"===e.type&&(s=function(){var n=[];return _.each(e.comments,function(e){var r=e.value.trim();r===publicAPI.options.commentCleanName&&n.push(e)}),n}(),_.each(s,function(e){c=e.loc.start.line,u[c]=!0}),publicAPI.commentLineNumbers=u),!l&&!p)return e;if(a=e.expression.loc.start.line,publicAPI.commentLineNumbers[a]||publicAPI.commentLineNumbers[""+(parseInt(a,10)-1)])return e;if(r=Array.prototype.slice.call(e.expression.arguments,0),t=function(){var e=p?r[0]:r[r.length-2],n=[];return e=_.isPlainObject(e)?e.elements||[]:[],Array.isArray(e)&&e.length&&_.each(e,function(e){publicAPI.dependencyBlacklist[e.value]?n.push("{}"):n.push(e.value)}),n}(),i=p?r[1]:r[r.length-1],n=publicAPI.normalizeModuleName(e.expression.arguments[0].value),o={node:e,moduleName:n,dependencies:t,moduleReturnValue:i,isDefine:l,isRequire:p},l){if(_.isArray(publicAPI.options.ignoreModules)&&-1!==publicAPI.options.ignoreModules.indexOf(n))return e;if(publicAPI.isFunctionExpression(i))return publicAPI.convertToFunctionExpression(o);if(publicAPI.isObjectExpression(i))return publicAPI.convertToObjectDeclaration(o)}else if(p)return d=_.isArray(e.expression.arguments)&&e.expression.arguments.length?e.expression.arguments[1]&&e.expression.arguments[1].body&&e.expression.arguments[1].body.body&&e.expression.arguments[1].body.body.length:!1,publicAPI.options.removeAllRequires!==!0&&d?publicAPI.convertToFunctionExpression(o):{type:"EmptyStatement"}},createAst:function(e){var n=e.filePath,r=e.code||(n&&"node"===publicAPI.env?publicAPI.readFile(n):""),t=publicAPI.defaultOptions.esprima,i=_.extend(t,_.isPlainObject(e.esprima)?e.esprima:{});if(r){if(!_.isPlainObject(esprima)||!_.isFunction(esprima.parse))throw new Error(publicAPI.errorMsgs.esprima);return esprima.parse(r,i)}throw new Error(publicAPI.errorMsgs.emptyCode)},traverseAndUpdateAst:function(e){if(!_.isPlainObject(e))throw new Error(publicAPI.errorMsgs.invalidObject("traverseAndUpdateAst"));var n=e.ast,r=function(e,n){return publicAPI.convertDefinesAndRequires(e,n)},t=function(e){return e},i=_.isFunction(e.enterFunc)?e.enterFunc:r,o=_.isFunction(e.leaveFunc)?e.leaveFunc:t;if(!n)throw new Error(publicAPI.errorMsgs.emptyAst("traverseAndUpdateAst"));if(!_.isPlainObject(estraverse)||!_.isFunction(estraverse.replace))throw new Error(exportedProps.errorMsgs.estraverse);return estraverse.replace(n,{enter:i,leave:o}),n},generateCode:function(e,n){if(!_.isPlainObject(escodegen)||!_.isFunction(escodegen.generate))throw new Error(exportedProps.errorMsgs.escodegen);return escodegen.generate(e,n)},clean:function(e){var n={},r={},t={};if(publicAPI.options=publicAPI.defaultOptions,_.isPlainObject(e)&&(publicAPI.options=t=_.extend({},publicAPI.options,e)),!_||!_.isPlainObject)throw new Error(publicAPI.errorMsgs.lodash);if(!_.isPlainObject(e)&&_.isString(e))n.code=e;else{if(!_.isPlainObject(e))throw new Error(publicAPI.errorMsgs.invalidObject("clean"));n=e}return r=publicAPI.traverseAndUpdateAst({ast:publicAPI.createAst(n)}),r&&_.isArray(r.body)&&estraverse.replace(r,{enter:function(e,n){if(void 0===e||"EmptyStatement"===e.type)_.each(n.body,function(e,r){(void 0===e||"EmptyStatement"===e.type)&&n.body.splice(r,1)});else if(publicAPI.isRequireExpression(e))return e.arguments&&e.arguments[0]&&e.arguments[0].value?{type:"Identifier",name:publicAPI.normalizeModuleName(e.arguments[0].value)}:e}}),_.isArray(t.globalModules)&&_.each(t.globalModules,function(e){_.isString(e)&&e.length&&r.body.push({type:"ExpressionStatement",expression:{type:"AssignmentExpression",operator:"=",left:{type:"MemberExpression",computed:!1,object:{type:"Identifier",name:"window"},property:{type:"Identifier",name:e}},right:{type:"Identifier",name:e}}})}),t.globalObject===!0&&t.globalObjectName&&!publicAPI.createdGlobalObject&&(t.rememberGlobalObject===!0&&(publicAPI.createdGlobalObject=!0),r.body.unshift({type:"VariableDeclaration",declarations:[{type:"VariableDeclarator",id:{type:"Identifier",name:t.globalObjectName},init:{type:"ObjectExpression",properties:[]}}],kind:"var"})),publicAPI.generateCode(r,t.escodegen)}};return"node"!==codeEnv?publicAPI:(module.exports=publicAPI,void 0)});